<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="gray.light.document.repository.DocumentCatalogsRepository">

    <!-- **** Common SQL **** -->

    <!-- 目录的需要更新的所有字段 -->
    <sql id="catalog_columns">(uid, project_id, document_id, parent_uid, created_date, updated_date, title,
                               folder)</sql>

    <!-- Select SQL -->

    <select id="findById"
            resultType="DocumentCatalog">
        select *
        from document_catalog
        where id = #{id}
        limit 1
    </select>

    <select id="findByDocumentId"
            resultType="DocumentCatalog">
        select *
        from document_catalog
        where document_id = #{documentId}
    </select>

    <!-- Insert SQL -->

    <insert id="save"
            parameterType="DocumentCatalog"
            useGeneratedKeys="true"
            keyProperty="id">
        insert into document_catalog
        <include refid="catalog_columns">
        </include>
        values (#{uid}, #{projectId}, #{documentId}, #{parentUid}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, #{title},
        #{folder})
    </insert>

    <insert id="saveIfMatchedProject"
            parameterType="DocumentCatalog"
            useGeneratedKeys="true"
            keyProperty="id">
        insert into document_catalog
        <include refid="catalog_columns">
        </include>
        select
        #{uid},
        #{projectId},
        #{documentId},
        #{parentUid},
        CURRENT_TIMESTAMP,
        CURRENT_TIMESTAMP,
        #{title},
        #{folder}
        from document as d
        where d.id = #{documentId}
    </insert>

    <insert id="saveIfMatchedParentAndExcludeFolder"
            parameterType="DocumentCatalog"
            useGeneratedKeys="true"
            keyProperty="id">
        insert into document_catalog
        <include refid="catalog_columns">
        </include>
        select
        #{catalog.uid},
        #{catalog.projectId},
        #{catalog.documentId},
        #{catalog.parentUid},
        CURRENT_TIMESTAMP,
        CURRENT_TIMESTAMP,
        #{catalog.title},
        #{catalog.folder}
        from document_catalog as c
        where c.id = #{catalog.parentUid}
        and c.folder != #{exclude}
    </insert>

    <insert id="batchSave"
            parameterType="java.util.List"
            useGeneratedKeys="true"
            keyProperty="id">
        insert into document_catalog
        <include refid="catalog_columns">
        </include>
        values(
        <foreach collection="catalogs" index="index" item="item" separator="),(">
            #{item.uid},
            #{item.projectId},
            #{item.documentId},
            #{item.parentUid},
            CURRENT_TIMESTAMP,
            CURRENT_TIMESTAMP,
            #{item.title},
            #{item.folder}
        </foreach>
        )
    </insert>

    <!-- Update SQL -->

    <update id="updateByFolder">
        update document_catalog
        set folder = #{folder}
        where uid = #{uid}
        limit 1
    </update>

</mapper>